# 一小时总结 -- 项目及项目难点

## 主要参与项目介绍

金融风控系统开发，设计实现金融风控系统，实现相关风险管控，项目要求：

- 满足需求、降低运维成本、保证服务稳定性；
	- 去单点计算；
	- 改造计算框架和规则引擎：压测稳定服务性能；
	- 服务告警；
	- 改造冗余链路、冗余功能、合并查询接口，降低内网 TPS，减少机器部署；
	- 198 台 -> 80 台
- 提供规则的灵活的规则配置中心；
- 实现数据的累计计算及快速开发；
- 性能目标：
	- 单机 TPS：3000；
	- 单机接口并发：600；（2000 最大线程池）
	- 接口延迟目标：200 ms 以内；
	- 可支撑数据量：日订单 100W；
- 预估数据：
	- 日增量 30 万数据
		- 订单成功率：10%；
	- 2 年约 2.1 亿数据；
	- 大概分 10 张表；

> - Tomcat 的核心配置为 2000 线程；
> - 理论上，如果平均响应时间在 20 ms，则 TPS 可达 10 W；
> 	- 1 thread 1 s 处理 50 个 request；
> 	- 2000 thread 理论上：10W；
> - 根据上面理论上：项目可跑 2000 并发，TPS 应该可以达到 1W TPS；
> 	- 考虑到业务实现，接口需要做大量的数据计算和规则运行，属于 CPU 密集型缓存占用内存也较大，并发在 300 左右 CPU 和内存资源也就满了；
> 

## 技术难点

- 性能难点：项目压测的时候一直无法到达预期 TPS，
	- 通过压测调整日志级别，修改逻辑降低用户锁定的数据粒度和范围逐步接近预期 TPS；
- 高可用难点：遗留的并发的数据累计框架为单机实现，无法做到水平扩展
	- 通过修改项目架构和框架部分实现实现水平扩展，提升性能高和高可用；
	- 热点商户的数据并发累计使用 Redis 做自增，持久化采用异步 MQ 入库
- 稳定性难点：接口延迟难以稳定，核心接口业务复杂非常依赖规则梳理
	- 解决了部分问题：修改引擎将数据准备完全后运行变成按需加载；
	- 目标方案：规则以多线程运行，多线程还无法解决可参考 Mapper/Reduce 思路做分布式运行；

> 核心接口需要做数据实时累计，关联数据的查询，规则运行，出入库逻辑，接口延时跟规则和指标成线性关系上升

## 实际运行指标

- 数据量：单日 1 万多 
	- 高峰期单日订单 30 万；
- 线上 TPS：200，压力不大；
- JVM 内存：1.8 g ， 24% 和 0.7 CPU；
- 压测：核心接口 TPS 可达 1000，CPU 利用率 85%，；
	- 第一次瓶颈：logback 的 info 级别日志导致大量 线程 等待，240 TPS 后上不去，jstack 查看等待原因；
	- 第二次瓶颈：ZK 加锁出现锁等待；

### 业务指标

- 日管控订单：30 万，上线半年，累计管控订单 2000 万；
- 管控金额：
	- 日入金 avg：
	- 日出金 avg：

### 线上内存占用率

```
top - 19:26:46 up 21 days,  2:03,  1 user,  load average: 0.07, 0.03, 0.01
Tasks:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie
Cpu(s):  0.1%us,  0.3%sy,  0.0%ni, 99.6%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Mem:   8059428k total,  7879960k used,   179468k free,   310060k buffers
Swap:  4296696k total,        0k used,  4296696k free,  5191128k cached

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 3827 work      20   0 7284m 1.8g  11m S  0.7 24.0  62:11.60 java
```

### ETL 项目压测和调优记录

- 压测到：2600 多；
- 并发：260 并发； 
- 延迟：8ms(100ms)

> http://wiki.jdb-dev.com/pages/viewpage.action?pageId=65128373
> 
> http://wiki.jdb-dev.com/pages/viewpage.action?pageId=67797296

## 项目扩展思路

- 线程模型：规则从单线程运行换为多线程跑；
	- 没有必要拆分为任务跑，那种规则就升级成为大数据模型了；
	- 规则量：万级左右拆分到千级别去跑即可，千级内单线程跑即可。
- 数据模型：按需要加载，分层累计缓存，减少运行时的数据运算；
	- 做容错加载；（风控业务允许一定的数据差错）
- 监控类规则的异步执行；